name: Manual Deploy

# Triggered manually from GitHub UI
on:
  workflow_dispatch:
    inputs:
      app:
        description: "Which app to deploy?"
        required: true
        type: choice
        options:
          - waitlist
          - web
          - tutorials
          - chat
          - admin
          - programs
          - coding-challenges
          - teams
          - job-board
          - store
          - docs
      environment:
        description: "Deploy to which environment?"
        required: true
        type: choice
        options:
          - development
          - production
        default: development

jobs:
  build-and-deploy:
    name: Build & Deploy ${{ inputs.app }} to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Install Turbo globally
        run: npm install -g turbo@2.5.8

      # Prune the monorepo for Docker deployment
      - name: Turbo prune for Docker
        run: |
          echo "ðŸ” Pruning monorepo for ${{ inputs.app }}"
          npx turbo prune ${{ inputs.app }} --docker

          # Copy the Dockerfile to the out directory
          if [ -f "Dockerfile" ]; then
            cp Dockerfile out/Dockerfile
            echo "âœ… Copied Dockerfile to out/"
          else
            echo "âŒ No Dockerfile found at root!"
            exit 1
          fi

          echo "ðŸ“¦ Pruned structure:"
          ls -la out/
          echo "ðŸ“¦ JSON structure:"
          ls -la out/json/
          echo "ðŸ“¦ Full structure:"
          ls -la out/full/ | head -20

      # Set up Docker Buildx for better build performance
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build Docker image
      - name: Build Docker image
        run: |
          cd out
          echo "ðŸ³ Building Docker image for ${{ inputs.app }}"
          docker buildx build \
            --build-arg APP_NAME=${{ inputs.app }} \
            --tag ${{ inputs.app }}:${{ github.sha }} \
            --tag ${{ inputs.app }}:latest \
            --load \
            .

          echo "âœ… Docker image built successfully"
          docker images | grep ${{ inputs.app }}

      # Install Railway CLI
      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      # Deploy to Railway
      - name: Deploy to Railway
        env:
          APP_NAME: ${{ inputs.app }}
          ENVIRONMENT: ${{ inputs.environment }}
          RAILWAY_DEV_TOKEN: ${{ secrets.RAILWAY_DEV_TOKEN }}
          RAILWAY_PROD_TOKEN: ${{ secrets.RAILWAY_PROD_TOKEN }}
        run: |
          # Set Railway token based on environment
          if [ "${ENVIRONMENT}" = "production" ]; then
            export RAILWAY_TOKEN="${RAILWAY_PROD_TOKEN}"
          else
            export RAILWAY_TOKEN="${RAILWAY_DEV_TOKEN}"
          fi

          # Set service ID based on app and environment
          case "${APP_NAME}" in
            waitlist)
              if [ "${ENVIRONMENT}" = "production" ]; then
                SERVICE_ID="${{ secrets.RAILWAY_WAITLIST_PROD_SERVICE_ID }}"
              else
                SERVICE_ID="${{ secrets.RAILWAY_WAITLIST_DEV_SERVICE_ID }}"
              fi
              ;;
            web)
              if [ "${ENVIRONMENT}" = "production" ]; then
                SERVICE_ID="${{ secrets.RAILWAY_WEB_PROD_SERVICE_ID }}"
              else
                SERVICE_ID="${{ secrets.RAILWAY_WEB_DEV_SERVICE_ID }}"
              fi
              ;;
            tutorials)
              if [ "${ENVIRONMENT}" = "production" ]; then
                SERVICE_ID="${{ secrets.RAILWAY_TUTORIALS_PROD_SERVICE_ID }}"
              else
                SERVICE_ID="${{ secrets.RAILWAY_TUTORIALS_DEV_SERVICE_ID }}"
              fi
              ;;
            chat)
              if [ "${ENVIRONMENT}" = "production" ]; then
                SERVICE_ID="${{ secrets.RAILWAY_CHAT_PROD_SERVICE_ID }}"
              else
                SERVICE_ID="${{ secrets.RAILWAY_CHAT_DEV_SERVICE_ID }}"
              fi
              ;;
            admin)
              if [ "${ENVIRONMENT}" = "production" ]; then
                SERVICE_ID="${{ secrets.RAILWAY_ADMIN_PROD_SERVICE_ID }}"
              else
                SERVICE_ID="${{ secrets.RAILWAY_ADMIN_DEV_SERVICE_ID }}"
              fi
              ;;
            programs)
              if [ "${ENVIRONMENT}" = "production" ]; then
                SERVICE_ID="${{ secrets.RAILWAY_PROGRAMS_PROD_SERVICE_ID }}"
              else
                SERVICE_ID="${{ secrets.RAILWAY_PROGRAMS_DEV_SERVICE_ID }}"
              fi
              ;;
            coding-challenges)
              if [ "${ENVIRONMENT}" = "production" ]; then
                SERVICE_ID="${{ secrets.RAILWAY_CODING_CHALLENGES_PROD_SERVICE_ID }}"
              else
                SERVICE_ID="${{ secrets.RAILWAY_CODING_CHALLENGES_DEV_SERVICE_ID }}"
              fi
              ;;
            teams)
              if [ "${ENVIRONMENT}" = "production" ]; then
                SERVICE_ID="${{ secrets.RAILWAY_TEAMS_PROD_SERVICE_ID }}"
              else
                SERVICE_ID="${{ secrets.RAILWAY_TEAMS_DEV_SERVICE_ID }}"
              fi
              ;;
            job-board)
              if [ "${ENVIRONMENT}" = "production" ]; then
                SERVICE_ID="${{ secrets.RAILWAY_JOB_BOARD_PROD_SERVICE_ID }}"
              else
                SERVICE_ID="${{ secrets.RAILWAY_JOB_BOARD_DEV_SERVICE_ID }}"
              fi
              ;;
            store)
              if [ "${ENVIRONMENT}" = "production" ]; then
                SERVICE_ID="${{ secrets.RAILWAY_STORE_PROD_SERVICE_ID }}"
              else
                SERVICE_ID="${{ secrets.RAILWAY_STORE_DEV_SERVICE_ID }}"
              fi
              ;;
            docs)
              if [ "${ENVIRONMENT}" = "production" ]; then
                SERVICE_ID="${{ secrets.RAILWAY_DOCS_PROD_SERVICE_ID }}"
              else
                SERVICE_ID="${{ secrets.RAILWAY_DOCS_DEV_SERVICE_ID }}"
              fi
              ;;
            *)
              echo "âŒ Unknown app: ${APP_NAME}"
              exit 1
              ;;
          esac

          # Validate required variables
          if [ -z "${RAILWAY_TOKEN}" ]; then
            echo "âŒ RAILWAY_TOKEN not found for ${ENVIRONMENT} environment"
            echo "Please ensure RAILWAY_DEV_TOKEN or RAILWAY_PROD_TOKEN secret is configured."
            exit 1
          fi

          if [ -z "${SERVICE_ID}" ]; then
            echo "âŒ SERVICE_ID not found for ${APP_NAME} in ${ENVIRONMENT}"
            echo "Please ensure the corresponding service ID secret is configured."
            exit 1
          fi

          echo "ðŸš€ Deploying ${APP_NAME} to ${ENVIRONMENT}"
          echo "Service ID: ${SERVICE_ID}"

          # Deploy using Railway CLI with Docker image
          cd out
          railway up --service="${SERVICE_ID}" --detach

      - name: Deployment summary
        if: success()
        run: |
          echo "### ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **App:** ${{ inputs.app }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image:** ${{ inputs.app }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Deployment failed
        if: failure()
        run: |
          echo "### âŒ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **App:** ${{ inputs.app }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for error details." >> $GITHUB_STEP_SUMMARY
